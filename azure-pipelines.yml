# https://aka.ms/yaml

trigger:
- main

pool:
  vmImage: macOS-latest

variables:
  Configuration: Release

steps:

- powershell: |
    & dotnet tool update --global boots --version 1.0.4.624
    & boots https://dl.internalx.com/vsts-devdiv/Xamarin.Android/public/5343278/d17-0/6b0e6b265390832dcfb499e9e1e893c462548a30/xamarin.android-12.1.0.5.pkg
  displayName: install Xamarin.Android

- task: MSBuild@1
  displayName: build Xamarin.Android app
  inputs:
    solution: XamarinAndroidApp/XamarinAndroidApp/XamarinAndroidApp.csproj
    msbuildArguments: -restore -t:SignAndroidPackage -p:AndroidPackageFormat=apk -bl:$(System.DefaultWorkingDirectory)/artifacts/logs/XamarinAndroidApp.binlog

- task: MSBuild@1
  displayName: build Xamarin.Forms app
  inputs:
    solution: XamarinFormsApp/XamarinFormsApp/XamarinFormsApp.Android/XamarinFormsApp.Android.csproj
    msbuildArguments: -restore -t:SignAndroidPackage -p:AndroidPackageFormat=apk -bl:$(System.DefaultWorkingDirectory)/artifacts/logs/XamarinFormsApp.binlog

- task: CopyFiles@2
  inputs:
    contents: '**/*-Signed.apk'
    targetFolder: artifacts/release

- task: MSBuild@1
  displayName: build Xamarin.Android app AOT
  inputs:
    solution: XamarinAndroidApp/XamarinAndroidApp/XamarinAndroidApp.csproj
    msbuildArguments: -restore -t:Clean,SignAndroidPackage -p:AndroidPackageFormat=apk -p:AotAssemblies=true -p:AndroidEnableProfiledAot=true -bl:$(System.DefaultWorkingDirectory)/artifacts/logs/XamarinAndroidApp-Aot.binlog

- task: MSBuild@1
  displayName: build Xamarin.Forms app AOT
  inputs:
    solution: XamarinFormsApp/XamarinFormsApp/XamarinFormsApp.Android/XamarinFormsApp.Android.csproj
    msbuildArguments: -restore -t:Clean,SignAndroidPackage -p:AndroidPackageFormat=apk -p:AotAssemblies=true -p:AndroidEnableProfiledAot=true -bl:$(System.DefaultWorkingDirectory)/artifacts/logs/XamarinFormsApp-Aot.binlog

- task: CopyFiles@2
  inputs:
    contents: '**/*-Signed.apk'
    targetFolder: artifacts/release-aot

- task: PublishBuildArtifacts@1
  displayName: upload artifacts
  inputs:
    artifactName: artifacts
    targetPath: artifacts
  condition: succeededOrFailed()
